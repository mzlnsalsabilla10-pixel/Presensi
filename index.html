<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Presensi GPS Mahasiswa - Universitas Negeri Malang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .btn-primary { transition: all 0.3s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
    .table-row { transition: background-color 0.2s ease; }
    .table-row:hover { background-color: #f8fafc; }
    .status-badge { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #667eea; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full bg-gray-50">
  <div class="w-full h-full overflow-auto">
    <!-- Header -->
    <div class="gradient-bg text-white py-8 px-4">
      <div class="max-w-6xl mx-auto">
        <h1 id="judul-halaman" class="text-4xl font-bold mb-2">Presensi GPS Mahasiswa</h1>
        <p id="nama-universitas" class="text-xl opacity-90">Universitas Negeri Malang</p>
      </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- Form Presensi Card -->
      <div class="bg-white rounded-2xl card-shadow p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Form Presensi</h2>

        <form id="presensi-form" class="space-y-6">
          <!-- Nama -->
          <div>
            <label for="nama" class="block text-sm font-semibold text-gray-700 mb-2">Nama Mahasiswa</label>
            <input type="text" id="nama" name="nama" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Masukkan nama lengkap">
          </div>

          <!-- NIM -->
          <div>
            <label for="nim" class="block text-sm font-semibold text-gray-700 mb-2">NIM</label>
            <input type="text" id="nim" name="nim" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: 200123456789">
          </div>

          <!-- Kelas -->
          <div>
            <label for="kelas" class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
            <input type="text" id="kelas" name="kelas" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Contoh: A / B / C">
          </div>

          <!-- GPS Info Display -->
          <div id="gps-info" class="hidden bg-green-50 border-2 border-green-200 rounded-lg p-4">
            <p class="text-sm font-semibold text-green-800 mb-2">‚úì Lokasi GPS Berhasil Diambil</p>
            <p class="text-xs text-green-600">Latitude: <span id="lat-display">-</span></p>
            <p class="text-xs text-green-600">Longitude: <span id="lng-display">-</span></p>
          </div>

          <!-- Buttons -->
          <div class="flex flex-col sm:flex-row gap-4">
            <button type="button" id="get-location-btn" class="flex-1 btn-primary bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2">
              <span id="location-text">üìç Ambil Lokasi GPS</span>
              <div id="location-spinner" class="loading-spinner hidden"></div>
            </button>

            <button type="submit" id="submit-btn" class="flex-1 btn-primary bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2" disabled>
              <span id="submit-text">‚úì Submit Presensi</span>
              <div id="submit-spinner" class="loading-spinner hidden"></div>
            </button>
          </div>
        </form>

        <!-- Status Message -->
        <div id="status-message" class="hidden mt-6"></div>
      </div>

      <!-- Dashboard Riwayat Presensi -->
      <div class="bg-white rounded-2xl card-shadow p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold text-gray-800">üìä Riwayat Presensi</h2>
          <div class="flex gap-3">
            <button id="export-csv-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-green-700 transition-colors flex items-center gap-2">üì• Export CSV</button>
            <button id="download-laporan-btn" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-orange-700 transition-colors flex items-center gap-2">üìÑ Download Laporan</button>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-sm text-blue-600 font-semibold">Total Presensi</p>
            <p id="total-presensi" class="text-3xl font-bold text-blue-700">0</p>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <p class="text-sm text-green-600 font-semibold">Hari Ini</p>
            <p id="presensi-hari-ini" class="text-3xl font-bold text-green-700">0</p>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <p class="text-sm text-purple-600 font-semibold">Mahasiswa Aktif</p>
            <p id="mahasiswa-aktif" class="text-3xl font-bold text-purple-700">0</p>
          </div>
        </div>

        <!-- Table Container -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">#</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIM</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jam</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Koordinat GPS</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody id="presensi-table-body" class="bg-white divide-y divide-gray-200">
              <tr id="empty-state">
                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                  <div class="flex flex-col items-center gap-2">
                    <span class="text-4xl">üì≠</span>
                    <p class="font-semibold">Belum ada data presensi</p>
                    <p class="text-sm">Silakan isi form di atas untuk mulai mencatat presensi</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Global state
    let currentLatitude = null;
    let currentLongitude = null;
    let allPresensiData = [];

    // Show status helper
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.className = `status-badge p-4 rounded-lg text-sm font-semibold ${
        type === 'success' ? 'bg-green-100 text-green-800 border-2 border-green-200' : 'bg-red-100 text-red-800 border-2 border-red-200'
      }`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
      setTimeout(() => statusDiv.classList.add('hidden'), 3500);
    }

    // Load presensi.json and render table + stats
    async function loadPresensi() {
      try {
        const res = await fetch('presensi.json?_=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('Gagal membaca presensi.json');
        const data = await res.json();
        allPresensiData = Array.isArray(data) ? data : [];
        renderTable(allPresensiData);
        updateSummaryStats(allPresensiData);
      } catch (err) {
        console.error(err);
        allPresensiData = [];
        renderTable([]);
        updateSummaryStats([]);
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('presensi-table-body');
      const emptyState = document.getElementById('empty-state');

      // clear rows (except empty-state placeholder)
      tbody.querySelectorAll('.table-row').forEach(r => r.remove());

      if (!data || data.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');

      data.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'table-row';
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm text-gray-600">${idx + 1}</td>
          <td class="px-4 py-3 text-sm text-gray-900">${escapeHtml(item.nama)}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(item.nim)}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(item.kelas)}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(item.tanggal)}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(item.jam)}</td>
          <td class="px-4 py-3 text-xs text-gray-500">${escapeHtml(item.latitude)}, ${escapeHtml(item.longitude)}</td>
          <td class="px-4 py-3 text-center">
            <button class="delete-btn text-red-600 hover:text-red-800 font-semibold text-sm" data-id="${item.id}">üóëÔ∏è Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);

        // attach delete handler
        tr.querySelector('.delete-btn').addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          if (!confirm('Hapus data presensi ini?')) return;
          try {
            const delRes = await fetch('delete.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id })
            });
            const delJson = await delRes.json();
            if (delJson.status === 'success') {
              showStatus('Data berhasil dihapus', 'success');
              await loadPresensi();
            } else {
              showStatus('Gagal menghapus data', 'error');
            }
          } catch (err) {
            console.error(err);
            showStatus('Error saat menghapus', 'error');
          }
        });
      });
    }

    function updateSummaryStats(data) {
      const today = new Date().toLocaleDateString('id-ID');
      const todayCount = data.filter(item => item.tanggal === today).length;
      const uniqueStudents = new Set(data.map(item => item.nim)).size;

      document.getElementById('total-presensi').textContent = data.length;
      document.getElementById('presensi-hari-ini').textContent = todayCount;
      document.getElementById('mahasiswa-aktif').textContent = uniqueStudents;
    }

    // Escape HTML to prevent injection when rendering
    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Get location button
    document.getElementById('get-location-btn').addEventListener('click', function () {
      const btn = this;
      const spinner = document.getElementById('location-spinner');
      btn.disabled = true;
      spinner.classList.remove('hidden');

      if (!navigator.geolocation) {
        showStatus('Browser tidak mendukung GPS', 'error');
        btn.disabled = false;
        spinner.classList.add('hidden');
        return;
      }

      navigator.geolocation.getCurrentPosition((position) => {
        currentLatitude = position.coords.latitude.toFixed(6);
        currentLongitude = position.coords.longitude.toFixed(6);

        document.getElementById('lat-display').textContent = currentLatitude;
        document.getElementById('lng-display').textContent = currentLongitude;
        document.getElementById('gps-info').classList.remove('hidden');
        document.getElementById('submit-btn').disabled = false;

        showStatus('Lokasi GPS berhasil diambil!', 'success');
        btn.disabled = false;
        spinner.classList.add('hidden');
      }, (error) => {
        let errorMsg = 'Gagal mengambil lokasi GPS';
        if (error.code === 1) errorMsg = 'Akses lokasi ditolak. Mohon izinkan akses lokasi.';
        if (error.code === 2) errorMsg = 'Lokasi tidak tersedia';
        if (error.code === 3) errorMsg = 'Timeout dalam mengambil lokasi';
        showStatus(errorMsg, 'error');
        btn.disabled = false;
        spinner.classList.add('hidden');
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    });

    // Submit presensi -> simpan.php
document.getElementById('presensi-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const nama = document.getElementById('nama').value.trim();
  const nim = document.getElementById('nim').value.trim();
  const kelas = document.getElementById('kelas').value.trim();

  if (!nama || !nim || !kelas) {
    showStatus('Lengkapi semua field sebelum submit', 'error');
    return;
  }
  if (!currentLatitude || !currentLongitude) {
    showStatus('Harap ambil lokasi GPS terlebih dahulu', 'error');
    return;
  }

  const presensiData = {
    nama,
    nim,
    kelas,
    latitude: currentLatitude,
    longitude: currentLongitude
  };

  const submitBtn = document.getElementById('submit-btn');
  const submitSpinner = document.getElementById('submit-spinner');
  submitBtn.disabled = true;
  submitSpinner.classList.remove('hidden');

  try {

    await fetch("https://script.google.com/macros/s/AKfycbxtTLh4qIXbtGd2AuSEQJuM7aUz4_1r6sSKxyqOvSI54R0KFHTSjXvoqY7Xn6nTu0z8/exec", {
      method: "POST",
      body: JSON.stringify(presensiData)
    });

    await fetch("simpan.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(presensiData)
    });

    await loadPresensi();

    showStatus("Presensi berhasil dikirim & disimpan!", "success");

    this.reset();
    document.getElementById("gps-info").classList.add("hidden");
    currentLatitude = null;
    currentLongitude = null;

  } catch (err) {
    console.error(err);
    showStatus("Gagal menyimpan presensi", "error");

  } finally {
    submitBtn.disabled = false;
    submitSpinner.classList.add('hidden');
  }
});


    // Export CSV
    document.getElementById('export-csv-btn').addEventListener('click', function () {
      if (allPresensiData.length === 0) {
        showStatus('Tidak ada data untuk diekspor', 'error');
        return;
      }
      let csv = 'Nama,NIM,Kelas,Tanggal,Jam,Latitude,Longitude\n';
      allPresensiData.forEach(item => {
        csv += `"${item.nama}","${item.nim}","${item.kelas}","${item.tanggal}","${item.jam}","${item.latitude}","${item.longitude}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `presensi_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      showStatus('Data berhasil diekspor ke CSV', 'success');
    });

    // Download laporan txt
    document.getElementById('download-laporan-btn').addEventListener('click', function () {
      if (allPresensiData.length === 0) {
        showStatus('Tidak ada data untuk laporan', 'error');
        return;
      }
      let laporan = `LAPORAN PRESENSI MAHASISWA\nUniversitas Negeri Malang\nTanggal: ${new Date().toLocaleDateString('id-ID')}\n============================================\n\n`;
      allPresensiData.forEach((item, idx) => {
        laporan += `${idx + 1}. ${item.nama} (${item.nim})\n   Kelas: ${item.kelas}\n   Waktu: ${item.tanggal} ${item.jam}\n   Koordinat: ${item.latitude}, ${item.longitude}\n\n`;
      });
      const blob = new Blob([laporan], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `laporan_presensi_${new Date().toISOString().slice(0, 10)}.txt`;
      a.click();
      window.URL.revokeObjectURL(url);
      showStatus('Laporan berhasil diunduh', 'success');
    });

    // Initialize (load data)
    async function initApp() {
      await loadPresensi();
      // ensure each loaded item has tanggal & jam (in case saved earlier)
      let changed = false;
      allPresensiData = allPresensiData.map(it => {
        if (!it.tanggal || !it.jam) {
          const d = formatNowForItem(it);
          changed = true;
          return { ...it, tanggal: d.tanggal, jam: d.jam };
        }
        return it;
      });
      if (changed) {
        // write back updated timestamps if needed (optional)
        try {
          await fetch('presensi.json', { method: 'PUT' }); // ignored in many servers, left as placeholder
        } catch (e) { /* ignore */ }
      }
    }

    function formatNowForItem(item) {
      const now = new Date();
      return { tanggal: now.toLocaleDateString('id-ID'), jam: now.toLocaleTimeString('id-ID') };
    }

    // start
    initApp();
  </script>
</body>
</html>
